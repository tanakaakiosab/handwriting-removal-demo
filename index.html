<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æ‰‹æ›¸ãæ–‡å­—é™¤å»ãƒ‡ãƒ¢</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background-color: #f5f5f5;
      max-width: 1200px;
      margin: 0 auto;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    canvas { 
      border: 2px solid #ddd; 
      max-width: 100%; 
      height: auto; 
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #controls { 
      margin-bottom: 20px;
      text-align: center;
    }
    input[type="file"] {
      margin-right: 10px;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 5px;
      background: white;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status.ready {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .canvas-section {
      margin: 20px 0;
    }
    .canvas-section h3 {
      color: #555;
      margin-bottom: 10px;
    }
    .threshold-control {
      margin: 10px 0;
      text-align: center;
    }
    .threshold-control label {
      display: inline-block;
      margin-right: 10px;
      font-weight: bold;
    }
    .threshold-control input[type="range"] {
      width: 200px;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ–‹ï¸ æ‰‹æ›¸ãæ–‡å­—é™¤å»ãƒ‡ãƒ¢</h1>
    
    <div id="status" class="status loading">OpenCV.js ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    
    <div id="controls">
      <input type="file" id="inputImage" accept="image/*" disabled />
      <button id="processBtn" disabled>ç”»åƒã‚’å‡¦ç†</button>
      <button id="saveBtn" disabled>çµæœã‚’ä¿å­˜</button>
    </div>

    <div class="threshold-control">
      <label for="thresholdSlider">é–¾å€¤èª¿æ•´:</label>
      <input type="range" id="thresholdSlider" min="80" max="180" value="120" disabled />
      <span id="thresholdValue">120</span>
    </div>

    <div class="canvas-section">
      <h3>ğŸ“· å…ƒç”»åƒ</h3>
      <canvas id="canvasInput"></canvas>
    </div>

    <div class="canvas-section">
      <h3>ğŸ¯ ãƒã‚¹ã‚¯ç”»åƒï¼ˆæ¤œå‡ºã•ã‚ŒãŸæ–‡å­—éƒ¨åˆ†ï¼‰</h3>
      <canvas id="maskCanvas"></canvas>
    </div>

    <div class="canvas-section">
      <h3>âœ¨ å‡¦ç†çµæœï¼ˆæ–‡å­—é™¤å»å¾Œï¼‰</h3>
      <canvas id="canvasOutput"></canvas>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>
  </div>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
  
  <script>
    let isOpenCVReady = false;
    let currentImage = null;

    // OpenCV.jsåˆæœŸåŒ–å®Œäº†æ™‚ã®å‡¦ç†
    function onOpenCvReady() {
      isOpenCVReady = true;
      const status = document.getElementById('status');
      const inputImage = document.getElementById('inputImage');
      const processBtn = document.getElementById('processBtn');
      const thresholdSlider = document.getElementById('thresholdSlider');
      
      status.textContent = 'âœ… OpenCV.js ã®èª­ã¿è¾¼ã¿å®Œäº†ï¼ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      status.className = 'status ready';
      
      inputImage.disabled = false;
      thresholdSlider.disabled = false;
      
      console.log('OpenCV.js is ready');
    }

    // ç”»åƒå‡¦ç†é–¢æ•°
    function processImage() {
      if (!isOpenCVReady || !currentImage) {
        alert('OpenCV.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return;
      }

      try {
        const canvasInput = document.getElementById('canvasInput');
        const canvasOutput = document.getElementById('canvasOutput');
        const maskCanvas = document.getElementById('maskCanvas');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const thresholdValue = parseInt(document.getElementById('thresholdSlider').value);

        // å…ƒç”»åƒã‚’èª­ã¿è¾¼ã¿
        const src = cv.imread(canvasInput);
        const gray = new cv.Mat();
        const mask = new cv.Mat();
        const dst = new cv.Mat();

        // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        
        // äºŒå€¤åŒ–ã§ãƒã‚¹ã‚¯ã‚’ä½œæˆï¼ˆæ–‡å­—éƒ¨åˆ†ã‚’ç™½ã€èƒŒæ™¯ã‚’é»’ã«ï¼‰
        cv.threshold(gray, mask, thresholdValue, 255, cv.THRESH_BINARY_INV);

        // ãƒã‚¹ã‚¯ç”»åƒã‚’è¡¨ç¤º
        maskCanvas.width = mask.cols;
        maskCanvas.height = mask.rows;
        cv.imshow(maskCanvas, mask);

        // ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒ†ã‚£ãƒ³ã‚°ï¼ˆæ–‡å­—é™¤å»ï¼‰
        cv.inpaint(src, mask, dst, 5, cv.INPAINT_NS);

        // çµæœã‚’è¡¨ç¤ºç”¨canvasã«æç”»
        canvasOutput.width = dst.cols;
        canvasOutput.height = dst.rows;
        cv.imshow(canvasOutput, dst);

        // ä¿å­˜ç”¨ã®éè¡¨ç¤ºcanvasã«æç”»
        hiddenCanvas.width = dst.cols;
        hiddenCanvas.height = dst.rows;
        cv.imshow(hiddenCanvas, dst);

        // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        document.getElementById('saveBtn').disabled = false;

        // ãƒ¡ãƒ¢ãƒªè§£æ”¾
        [src, gray, mask, dst].forEach(mat => mat.delete());

        console.log('ç”»åƒå‡¦ç†å®Œäº†');
      } catch (error) {
        console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const inputImage = document.getElementById('inputImage');
      const processBtn = document.getElementById('processBtn');
      const saveBtn = document.getElementById('saveBtn');
      const thresholdSlider = document.getElementById('thresholdSlider');
      const thresholdValue = document.getElementById('thresholdValue');

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
      inputImage.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvasInput = document.getElementById('canvasInput');
            const ctx = canvasInput.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
            canvasInput.width = img.width;
            canvasInput.height = img.height;
            
            // ç”»åƒã‚’æç”»
            ctx.drawImage(img, 0, 0);
            
            currentImage = img;
            processBtn.disabled = false;
            
            console.log('ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†:', img.width, 'x', img.height);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      // å‡¦ç†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
      processBtn.addEventListener('click', processImage);

      // é–¾å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å¤‰æ›´æ™‚
      thresholdSlider.addEventListener('input', function() {
        thresholdValue.textContent = this.value;
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (currentImage && isOpenCVReady) {
          processImage();
        }
      });

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
      saveBtn.addEventListener('click', function() {
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        if (hiddenCanvas.width === 0 || hiddenCanvas.height === 0) {
          alert('ä¿å­˜ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšç”»åƒã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        try {
          const link = document.createElement('a');
          link.download = 'handwriting_removed_' + new Date().getTime() + '.png';
          link.href = hiddenCanvas.toDataURL('image/png');
          link.click();
          console.log('ç”»åƒä¿å­˜å®Œäº†');
        } catch (error) {
          console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»åƒã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
      });
    });

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', function(e) {
      console.error('ã‚¨ãƒ©ãƒ¼:', e.error);
    });
  </script>
</body>
</html>
